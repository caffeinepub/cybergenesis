{
  "kind": "build_request",
  "title": "Apply V.10.1.PBR visual reconstruction and stability lock to CubeVisualization and LandModel",
  "priority": "normal",
  "requirements": [
    {
      "id": "REQ-1",
      "text": "Update frontend/src/components/CubeVisualization.tsx to match the V.10.1.PBR Canvas and lighting specification: set renderer tone mapping to THREE.ACESFilmicToneMapping, outputColorSpace to THREE.SRGBColorSpace, and toneMappingExposure to 0.6 in the Canvas onCreated hook; adjust light balance to KeyLight intensity={Math.PI * 2.2} color=\"#ffffff\", SunLight intensity={Math.PI * 0.5} color=\"#ffe4b5\", HemisphereLight intensity={1.05} skyColor=\"#f7f7f7\" groundColor=\"#3a3a3a\"; set <Environment preset=\"sunset\" environmentIntensity={1.0} />; and implement KeyLight camera sync using useFrame so the KeyLight position is set every frame to (camera.x + 10, camera.y + 15, camera.z + 10).",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1",
          "msg-2"
        ],
        "quotes": [
          "TASK: FINAL VISUAL RECONSTRUCTION & STABILITY LOCK (V.10.1.PBR)",
          "In CubeVisualisation.tsx (Canvas & Lighting): ... toneMappingExposure = 0.6 ... KeyLight Sync ... Light Balance ... Environment preset=\"sunset\", environmentIntensity={1.0}."
        ]
      },
      "acceptanceCriteria": [
        "In CubeVisualization.tsx, Canvas.onCreated sets gl.toneMapping = THREE.ACESFilmicToneMapping, gl.outputColorSpace = THREE.SRGBColorSpace, and gl.toneMappingExposure = 0.6.",
        "KeyLight is referenced via a ref and its position is updated each frame using useFrame to follow the camera with the exact offsets (+10, +15, +10).",
        "The rendered scene uses Environment preset \"sunset\" with environmentIntensity exactly 1.0.",
        "HemisphereLight uses intensity 1.05 with skyColor \"#f7f7f7\" and groundColor \"#3a3a3a\".",
        "KeyLight intensity equals Math.PI * 2.2 and SunLight intensity equals Math.PI * 0.5, with colors matching the prompt (#ffffff and #ffe4b5 respectively)."
      ]
    },
    {
      "id": "REQ-2",
      "text": "Update frontend/src/components/LandModel.tsx to match the V.10.1.PBR material traversal and camera-fit safety rules: call gltf.scene.updateMatrixWorld() before computing the Box3; perform material traversal only inside a guard `if (gltf.scene?.isObject3D) { ... }`; implement the emissive \"Glow List\" behavior based on object/material name containing any of MYTHIC_VOID, MYTHIC_AETHER, FOREST_VALLEY, DESERT_DUNE, ISLAND_ARCHIPELAGO, VOLCANIC_CRAG (if m.map exists set m.emissiveMap = m.map; set m.emissive to white and m.emissiveIntensity to 2.0); implement per-biome envMapIntensity rules based on name (AETHER/VOID/FOREST/DESERT/ISLAND -> 2.0; VOLCANIC_CRAG -> 1.3; otherwise default 1.0); enforce the PBR guard (do not manually set m.roughness or m.metalness when m.roughnessMap exists); and remove any `m.needsUpdate = true` assignments from inside the traversal loop for performance.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1",
          "msg-2"
        ],
        "quotes": [
          "In LandModel.tsx (Material Logic): Safety: gltf.scene.updateMatrixWorld() MUST be called BEFORE Box3 calculation.",
          "Traverse Logic ... Emissive 2.0 (The Glow List) ... Environment Intensity (Reflection Boost) ... PBR Guard ... Performance: Strictly NO m.needsUpdate = true inside the loop."
        ]
      },
      "acceptanceCriteria": [
        "LandModel calls gltf.scene.updateMatrixWorld() before creating/using THREE.Box3().setFromObject(gltf.scene).",
        "Material traversal logic is wrapped in a `if (gltf.scene?.isObject3D)` guard.",
        "For meshes whose name matches the Glow List biome tags, emissiveMap is set from map when present, emissive color is set to white, and emissiveIntensity is exactly 2.0.",
        "envMapIntensity is set to 2.0 for MYTHIC_AETHER/MYTHIC_VOID/FOREST_VALLEY/DESERT_DUNE/ISLAND_ARCHIPELAGO name matches, 1.3 for VOLCANIC_CRAG, and 1.0 otherwise (e.g., SNOW_PEAK).",
        "No `m.needsUpdate = true` exists inside the traverse loop.",
        "The code does not introduce manual roughness/metalness overrides when roughnessMap is present."
      ]
    },
    {
      "id": "REQ-3",
      "text": "Apply the global stability constraints from V.10.1.PBR across the 3D renderer components involved in this task: ensure no light uses castShadow={true} (remove any such props rather than enabling shadows), and ensure no manual gl.dispose() is added in any cleanup logic related to CubeVisualization/LandModel.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1",
          "msg-2"
        ],
        "quotes": [
          "Global Stability: REMOVE all castShadow={true} from lights.",
          "NO manual gl.dispose() in cleanup."
        ]
      },
      "acceptanceCriteria": [
        "No directional/spot/point lights in CubeVisualization (and related components touched by this change) have castShadow set to true.",
        "No cleanup code in these components calls gl.dispose()."
      ]
    }
  ],
  "constraints": [
    "Frontend immutable paths must not be edited: frontend/src/hooks/useInternetIdentity.ts, frontend/src/hooks/useInternetIdentity.tsx, frontend/src/hooks/useActor.ts, frontend/src/main.tsx, frontend/src/components/ui.",
    "Keep changes strictly limited to implementing the V.10.1.PBR prompt requirements; do not introduce unrelated refactors.",
    "Backend is single-actor Motoko; no backend changes are required for this task."
  ],
  "nonGoals": [
    "Implementing or automating platform-level draft rollback/rebuild to version 321 (non-code platform action).",
    "Adding new biomes or changing the BIOME_MODEL_MAP URLs.",
    "Introducing new rendering features beyond the prompt (e.g., postprocessing, shadow maps, custom HDRIs, new UI controls)."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  },
  "userProfileUpdate": {
    "goalsToAdd": [],
    "goalsToRemove": [],
    "preferencesToAdd": [],
    "preferencesToRemove": [],
    "miscToAdd": [],
    "miscToRemove": [],
    "fieldsToSet": {},
    "fieldsToDelete": []
  }
}